# D2D Protocol - Money Flow Architecture

## Executive Summary

D2D Protocol là một nền tảng DeFi trên Solana cho phép **Stakers (Backers)** stake SOL để nhận rewards, trong khi protocol sử dụng SOL đó để **fund deployments** cho developers. Document này mô tả chi tiết luồng tiền trong hệ thống.

---

## 1. Các Account Balance Chính

### 1.1 TreasuryPool - Các trường balance quan trọng

```rust
// === BALANCE CHÍNH ===
pub liquid_balance: u64;           // SOL có thể dùng cho deployments & withdrawals
pub total_deposited: u64;          // Tổng SOL được stake bởi tất cả stakers
pub reward_pool_balance: u64;      // Pool rewards để trả cho stakers
pub platform_pool_balance: u64;    // Pool phí platform cho admin

// === DEBT TRACKING ===
pub total_borrowed: u64;           // Tổng SOL đang được vay cho deployments
pub total_recovered: u64;          // Tổng SOL đã recover từ rent
pub total_debt_repaid: u64;        // Tổng nợ đã trả

// === REWARD TRACKING ===
pub reward_per_share: u128;        // Accumulator cho reward distribution
pub pending_undistributed_rewards: u64;  // Rewards chờ phân phối
pub total_stake_duration_weight: u128;   // Tổng weight theo thời gian stake
```

### 1.2 Mối quan hệ giữa các balance

```
┌──────────────────────────────────────────────────────────────────┐
│              TREASURY PDA (Physical SOL Balance)                  │
├──────────────────────────────────────────────────────────────────┤
│  liquid_balance          │ Cho deployments + withdrawals         │
│  + reward_pool_balance   │ Cho staker rewards                    │
│  + platform_pool_balance │ Cho admin operations                  │
│  + pending_undistributed │ Rewards chờ phân phối                 │
│  ≈ Total Lamports        │                                       │
└──────────────────────────────────────────────────────────────────┘
```

---

## 2. Staker Deposit Flow (stake_sol)

### 2.1 Flow Diagram

```
┌─────────────┐     SOL Transfer      ┌─────────────────┐
│   Staker    │ ───────────────────▶  │  Treasury PDA   │
│   Wallet    │                       │  liquid_balance │
└─────────────┘                       └─────────────────┘
                                              │
                              ┌───────────────┼───────────────┐
                              ▼               ▼               ▼
                        ┌──────────┐   ┌───────────┐   ┌───────────┐
                        │total_    │   │reward_    │   │platform_  │
                        │deposited │   │pool (1%)  │   │pool(0.1%) │
                        └──────────┘   └───────────┘   └───────────┘
```

### 2.2 State Changes

```typescript
// Khi staker deposit amount SOL:

// 1. Transfer SOL vào Treasury PDA
treasury_pda.lamports += amount;

// 2. Update balances
treasury_pool.total_deposited += amount;
treasury_pool.liquid_balance += amount;

// 3. Fee calculation (nếu có fee trên deposits)
reward_fee = (amount * 100) / 10000;     // 1%
platform_fee = (amount * 10) / 10000;    // 0.1%

// 4. Update reward tracking
lender_stake.deposited_amount += amount;
lender_stake.reward_debt = deposited_amount * reward_per_share;
```

### 2.3 First Depositor Protection

Để ngăn chặn **first-depositor arbitrage** (người đầu tiên claim hết rewards tích lũy):

```typescript
if (total_deposited_before == 0 && reward_pool_balance > 0) {
    // KHÔNG cộng vào reward_per_share ngay
    // Di chuyển vào pending để phân phối dần
    pending_undistributed_rewards += reward_pool_balance;

    // Emit event để tracking
    emit!(RewardsMovedToPending { amount, reason: "first_depositor_protection" });
}
```

### 2.4 Duration Tracking

```typescript
// Với staker đã có deposit trước đó:
if (!is_new_deposit) {
    // Tính weight = amount * thời gian đã stake
    duration = current_time - lender_stake.last_action_at;
    weight_delta = deposited_amount * duration;

    lender_stake.stake_duration_weight += weight_delta;
    treasury_pool.total_stake_duration_weight += weight_delta;
}

// Update timestamp
lender_stake.last_action_at = current_time;
```

---

## 3. Reward Calculation Model

### 3.1 Reward Per Share Accumulator

D2D sử dụng mô hình **Reward Per Share** giống Jito/Solayer:

```
PRECISION = 1,000,000,000,000 (10^12)

// Khi có rewards mới (từ fees):
delta = (reward_amount * PRECISION) / total_deposited
reward_per_share += delta

// Claimable rewards cho một staker:
accumulated = deposited_amount * reward_per_share
claimable = (accumulated - reward_debt) / PRECISION
```

### 3.2 Ví dụ minh họa

```
Scenario:
- Total Deposited: 1,000 SOL
- Staker A: 100 SOL (10%)
- Staker B: 900 SOL (90%)
- New reward: 10 SOL

Calculation:
delta = (10 * 10^12) / 1000 = 10^10
reward_per_share += 10^10

Staker A claimable:
= (100 * 10^10 - 0) / 10^12
= 10^12 / 10^12
= 1 SOL (10% of 10 SOL) ✓

Staker B claimable:
= (900 * 10^10 - 0) / 10^12
= 9 * 10^12 / 10^12
= 9 SOL (90% of 10 SOL) ✓
```

### 3.3 Duration-Weighted Bonus

Stakers stake lâu hơn được thưởng thêm từ `pending_undistributed_rewards`:

```typescript
// Mỗi staker có weight theo thời gian:
stake_duration_weight = deposited_amount * (current_time - last_action_at)

// Treasury tracking tổng weight:
total_stake_duration_weight = Σ(all stakers' weights)

// Duration bonus khi claim:
duration_bonus = pending_undistributed_rewards * (staker_weight / total_weight)
```

---

## 4. Claim Rewards Flow

### 4.1 Two Sources of Rewards

```
┌─────────────────────────────────────────────────────────────────┐
│                     CLAIMABLE REWARDS                            │
├────────────────────────────┬────────────────────────────────────┤
│   BASE REWARDS             │   DURATION BONUS                   │
│   (reward_per_share)       │   (pending_undistributed)          │
├────────────────────────────┼────────────────────────────────────┤
│ Source: reward_pool_balance│ Source: pending_undistributed      │
│ Formula:                   │ Formula:                           │
│ (amount * rps - debt)      │ pending * (weight/total_weight)    │
│ / PRECISION                │                                    │
└────────────────────────────┴────────────────────────────────────┘
                    │
                    ▼
            ┌───────────────┐
            │ TOTAL CLAIM   │
            │ = base + bonus│
            └───────────────┘
```

### 4.2 Claim Process

```typescript
// 1. Update duration weight trước
weight_delta = lender_stake.update_duration_weight(current_time);

// 2. Calculate base claimable
base_claimable = calculate_claimable_rewards(deposited_amount, reward_debt);

// 3. Calculate duration bonus
duration_bonus = pending_undistributed_rewards * staker_weight / total_weight;

// 4. Total claimable
total_claimable = base_claimable + duration_bonus;

// 5. State updates
lender_stake.claimed_total += total_claimable;
lender_stake.reward_debt = deposited_amount * reward_per_share;
lender_stake.stake_duration_weight = 0;  // Reset sau claim
lender_stake.pending_rewards = 0;

treasury_pool.reward_pool_balance -= base_claimable;
treasury_pool.pending_undistributed_rewards -= duration_bonus;
treasury_pool.total_claimed_rewards += base_claimable;

// 6. Transfer SOL
reward_pool_pda → lender_wallet (total_claimable)
```

---

## 5. Withdrawal Flow

### 5.1 Immediate Withdrawal (unstake_sol)

Khi `liquid_balance >= withdrawal_amount`:

```
┌─────────────┐     SOL Transfer      ┌─────────────────┐
│   Staker    │ ◀─────────────────── │  Treasury PDA   │
│   Wallet    │                       │  liquid_balance │
└─────────────┘                       └─────────────────┘
```

```typescript
// Validations
require!(liquid_balance >= amount);
require!(!lender_stake.has_queued_withdrawal());

// Update duration weight trước khi withdraw
weight_delta = lender_stake.update_duration_weight(current_time);

// State updates
lender_stake.deposited_amount -= amount;
treasury_pool.total_deposited -= amount;
treasury_pool.liquid_balance -= amount;

// Transfer
treasury_pda → lender_wallet (amount)
```

### 5.2 Queued Withdrawal

Khi `liquid_balance < withdrawal_amount` (liquidity bị locked trong deployments):

```
┌─────────────┐                       ┌─────────────────┐
│   Staker    │ ─── Request ────────▶ │  Withdrawal     │
│   Wallet    │                       │  Queue          │
└─────────────┘                       └─────────────────┘
                                              │
                                      Chờ rent recovery
                                              │
                                              ▼
                                      ┌───────────────┐
                                      │  Process khi  │
                                      │  có liquidity │
                                      └───────────────┘
```

```typescript
// queue_withdrawal instruction
queue_entry = WithdrawalQueueEntry {
    position: withdrawal_queue_tail,
    staker: requester,
    amount: withdrawal_amount,
    queued_at: current_time,
    processed: false,
};

// Update states
lender_stake.queued_withdrawal = amount;
lender_stake.queue_position = position;
treasury_pool.withdrawal_queue_tail += 1;
treasury_pool.queued_withdrawal_amount += amount;

// LƯU Ý: amount CHƯA bị trừ khỏi total_deposited
// Staker vẫn nhận rewards cho đến khi withdrawal được process
```

### 5.3 Cancel Queued Withdrawal

Staker có thể cancel withdrawal đang queue:

```typescript
// cancel_queued_withdrawal instruction
require!(lender_stake.has_queued_withdrawal());

// Reset states
treasury_pool.queued_withdrawal_amount -= amount;
lender_stake.queued_withdrawal = 0;
lender_stake.queue_position = 0;
queue_entry.processed = true;  // Mark as cancelled
```

---

## 6. Developer Payment Flow

### 6.1 Subscription Payment

Developers trả phí để maintain program deployments:

```
┌─────────────┐     SOL Transfer      ┌─────────────────┐
│  Developer  │ ───────────────────▶  │   Dev Wallet    │
│   Wallet    │                       │  (treasury.dev) │
└─────────────┘                       └─────────────────┘
                                              │
                                   credit_reward_pool()
                                              │
                                              ▼
                                      ┌───────────────┐
                                      │ reward_pool   │
                                      │ balance += fee│
                                      └───────────────┘
```

### 6.2 Fee Structure

```typescript
// Fee types:
1. Service Fee (one-time): deploy_request.service_fee
2. Monthly Fee: deploy_request.monthly_fee * months
3. Monthly Borrow Fee (1%): borrowed_amount * 100 / 10000

// Phân phối fees:
subscription_fees → reward_pool_balance  // Cho stakers
platform_fees → platform_pool_balance    // Cho admin
```

---

## 7. Deployment & Debt Flow

### 7.1 Fund Temporary Wallet (Borrowing)

Khi admin fund deployment cho developer:

```
┌─────────────────┐    lamport mutation   ┌───────────────────┐
│  Treasury PDA   │ ────────────────────▶ │ Temporary Wallet  │
│  liquid_balance │                       │ (ephemeral_key)   │
└─────────────────┘                       └───────────────────┘
```

```typescript
// Validations
require!(liquid_balance >= deployment_cost);
require!(check_utilization_limit(deployment_cost));  // 80% max

// State updates - Treasury
treasury_pool.liquid_balance -= deployment_cost;
treasury_pool.total_borrowed += deployment_cost;
treasury_pool.active_deployment_count += 1;

// State updates - DeployRequest
deploy_request.borrowed_amount = deployment_cost;
deploy_request.ephemeral_key = temporary_wallet;
deploy_request.expected_rent_recovery = deployment_cost * 80%;  // ~80%
```

### 7.2 Pool Utilization Limit

Bảo vệ stakers bằng cách giới hạn 80% utilization:

```typescript
MAX_UTILIZATION_BPS = 8000;  // 80%

check_utilization_limit(deployment_amount):
    // Sau deployment, phải còn ít nhất 20% liquid
    remaining = liquid_balance - deployment_amount;
    min_reserve = total_deposited * 20 / 100;
    return remaining >= min_reserve;
```

**Visualization:**

```
┌────────────────────────────────────────────────────────────┐
│                     TOTAL_DEPOSITED                         │
├────────────────────────────────────┬───────────────────────┤
│      BORROWED (max 80%)            │  RESERVE (min 20%)    │
│      For deployments               │  For withdrawals      │
│                                    │                       │
│  ████████████████████████████████  │  ░░░░░░░░░░░░░░░░░░  │
│                                    │                       │
└────────────────────────────────────┴───────────────────────┘
```

### 7.3 Rent Recovery (Debt Repayment)

Khi program expires và bị close:

```
┌───────────────────┐   close_any()    ┌─────────────────┐
│   Program Data    │ ───────────────▶ │  Treasury PDA   │
│   (rent lamports) │                  │  recovered_rent │
└───────────────────┘                  └─────────────────┘
                                               │
                               ┌───────────────┴───────────────┐
                               ▼                               ▼
                       ┌───────────────┐               ┌───────────────┐
                       │ Debt Repayment│               │ Excess Rewards│
                       │ → liquid_bal  │               │ → reward_pool │
                       └───────────────┘               └───────────────┘
```

```typescript
// reclaim_program_rent instruction
recovered = program_data.lamports;
remaining_debt = borrowed_amount - repaid_amount;

// Split recovered funds
debt_repayment = min(recovered, remaining_debt);
excess_to_rewards = recovered - debt_repayment;

// Per-deployment tracking
deploy_request.repaid_amount += debt_repayment;
deploy_request.actual_rent_recovered = recovered;
deploy_request.recovery_ratio_bps = (recovered / borrowed) * 10000;

// Global tracking
treasury_pool.total_recovered += recovered;
treasury_pool.total_debt_repaid += debt_repayment;
treasury_pool.total_borrowed -= debt_repayment;
treasury_pool.active_deployment_count -= 1;

// CRITICAL: Restore liquid balance
treasury_pool.liquid_balance += debt_repayment;

// Excess goes to stakers
if (excess_to_rewards > 0) {
    credit_fee_to_pool(excess_to_rewards, 0);
}
```

---

## 8. Pending Rewards Distribution

### 8.1 Gradual Distribution

Admin/cron periodically calls `distribute_pending_rewards`:

```typescript
distribute_pending_rewards(distribution_percentage_bps):
    // e.g., 1000 bps = 10% mỗi lần

    amount_to_distribute = pending_undistributed_rewards * percentage / 10000;

    // Update reward_per_share
    delta = (amount_to_distribute * PRECISION) / total_deposited;
    reward_per_share += delta;

    // Reduce pending
    pending_undistributed_rewards -= amount_to_distribute;

    return amount_to_distribute;
```

### 8.2 Recommended Schedule

| Frequency | Percentage | Use Case |
|-----------|------------|----------|
| Daily | 1000 bps (10%) | Normal operation |
| Weekly | 5000 bps (50%) | Slow release |
| On-demand | 10000 bps (100%) | Full distribution |

---

## 9. Dynamic APY Calculation

APY tăng khi utilization cao để attract thêm deposits:

```typescript
// Constants
DEFAULT_BASE_APY_BPS = 500;           // 5% base APY
MAX_UTILIZATION_BPS = 8000;           // 80%
TARGET_UTILIZATION_BPS = 6000;        // 60%
MAX_APY_MULTIPLIER_BPS = 30000;       // 3x max

calculate_current_apy():
    utilization = total_borrowed / total_deposited;

    if utilization >= 80%:
        multiplier = 3.0x  // Max
    else if utilization >= 60%:
        // Linear từ 1.5x → 3x
        multiplier = 1.5 + 1.5 * ((utilization - 60%) / 20%)
    else:
        // Linear từ 1x → 1.5x
        multiplier = 1.0 + 0.5 * (utilization / 60%)

    return base_apy * multiplier;
```

**APY Curve:**

```
APY
 ▲
15%├────────────────────────────────────────────█
   │                                        ████
   │                                    ████
10%├────────────────────────────────████
   │                            ████
   │                        ████
7.5%├───────────────────████
   │               █████
   │          █████
 5%├─────█████
   └───────┬──────────┬──────────┬──────────┬───▶ Utilization
          20%        40%        60%        80%
```

---

## 10. Complete Money Flow Diagram

```
                         ┌─────────────────────────────────────┐
                         │           D2D PROTOCOL              │
                         └─────────────────────────────────────┘

  STAKERS                         TREASURY                      DEVELOPERS
  ═══════                         ════════                      ══════════

  ┌──────────┐    stake_sol    ┌──────────────────────────┐
  │  Staker  │ ───────────────▶│     TREASURY PDA         │
  │  Wallet  │                 │ ┌──────────────────────┐ │
  └──────────┘                 │ │   liquid_balance     │ │◀─── rent recovery
       │                       │ │   (deposits +        │ │        │
       │                       │ │    repayments)       │ │        │
       │    unstake_sol        │ └──────────┬───────────┘ │        │
       │◀───────────────────── │            │             │        │
       │   (if liquid avail)   │            │ fund_       │        │
       │                       │            │ temporary   │        │
       │    queue_withdrawal   │            ▼ wallet      │        │
       │ ─────────────────────▶│ ┌──────────────────────┐ │        │
       │   (if no liquid)      │ │   Temp Wallet        │─┼────────┤
       │                       │ │   (for deployment)   │ │        │
       │                       │ └──────────────────────┘ │        │
       │                       │                          │        │
       │                       │ ┌──────────────────────┐ │        │
       │    claim_rewards      │ │   reward_pool        │ │        │
       │◀──────────────────────│ │   balance            │◀┼────────┤
       │                       │ │   (staker rewards)   │ │  subscription
       │                       │ └──────────────────────┘ │  fees
       │                       │                          │        │
       │                       │ ┌──────────────────────┐ │  ┌───────────┐
       │                       │ │   platform_pool      │ │  │ Developer │
       │                       │ │   balance            │ │  │  Wallet   │
       │                       │ │   (admin ops)        │ │  └───────────┘
       │                       │ └──────────────────────┘ │
       │                       │                          │
       │                       │ ┌──────────────────────┐ │
       │  duration_bonus       │ │   pending_undist     │ │
       │◀──────────────────────│ │   rewards            │ │
       │                       │ │   (fair dist)        │ │
       │                       │ └──────────────────────┘ │
       │                       └──────────────────────────┘

  ┌──────────────────────────────────────────────────────────────────┐
  │                         KEY FORMULAS                              │
  ├──────────────────────────────────────────────────────────────────┤
  │  claimable = (amount × rps - debt) / PRECISION                   │
  │  duration_bonus = pending × (staker_weight / total_weight)       │
  │  utilization = total_borrowed / total_deposited                  │
  │  recovery_ratio = actual_recovered / borrowed × 100%             │
  └──────────────────────────────────────────────────────────────────┘
```

---

## 11. Security Invariants

### 11.1 Balance Invariants

```
✓ liquid_balance ≤ total_deposited (can't lend more than staked)
✓ total_borrowed ≤ 80% of total_deposited (utilization limit)
✓ reward_pool_balance ≥ protected_rewards (staker claims protected)
✓ queued_withdrawal_amount ≤ total_deposited - liquid_balance
```

### 11.2 Overflow Protection

Tất cả arithmetic operations sử dụng `checked_*` methods:

```rust
// Ví dụ
self.total_deposited = self.total_deposited
    .checked_add(amount)
    .ok_or(ErrorCode::CalculationOverflow)?;
```

### 11.3 Reentrancy Protection

- All state updates happen BEFORE transfers
- CPI calls are at the end of instructions

---

## 12. Error Codes Reference

| Error | Description |
|-------|-------------|
| `InsufficientLiquidBalance` | liquid_balance < withdrawal amount |
| `PoolUtilizationTooHigh` | Would exceed 80% utilization |
| `WithdrawalAlreadyQueued` | Staker already has pending withdrawal |
| `NoQueuedWithdrawal` | Trying to cancel non-existent queue |
| `NoStakersForDistribution` | total_deposited = 0 when distributing |
| `RewardDebtExceedsAccumulated` | Invalid reward calculation state |

---

## 13. Summary

### Money Sources:
1. **Staker Deposits** → `liquid_balance` + `total_deposited`
2. **Subscription Fees** → `reward_pool_balance`
3. **Rent Recovery** → `liquid_balance` (debt) + `reward_pool` (excess)

### Money Uses:
1. **Deployments** ← `liquid_balance` (borrowed with 80% limit)
2. **Withdrawals** ← `liquid_balance`
3. **Reward Claims** ← `reward_pool_balance` + `pending_undistributed`

### Key Protection Mechanisms:
1. **80% Utilization Limit** - Ensures 20% always available for withdrawals
2. **First Depositor Protection** - Prevents reward sniping
3. **Duration-Weighted Rewards** - Incentivizes long-term staking
4. **Withdrawal Queue** - Handles low liquidity gracefully
5. **Debt Tracking** - Transparent borrowed/recovered accounting
